<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Футбольная Викторина РПЛ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f2f5; color: #333; }
        .container { text-align: center; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 95%; max-width: 500px; }
        .hidden { display: none; }
        button { background-color: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; margin: 5px; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover:not(:disabled) { background-color: #c82333; }
        input[type="text"], input[type="password"], input[type="number"] { width: 80%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; font-size: 1em; }
        h1, h2, h3, h4 { margin-top: 0; }
        .error-message { color: #dc3545; }
        .auth-toggle { font-size: 0.9em; color: #007bff; cursor: pointer; text-decoration: underline; margin-top: 15px; }
        .lobby-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .lobby-stats { display: flex; justify-content: space-around; padding: 10px; margin-bottom: 20px; background-color: #f0f2f5; border-radius: 8px; }
        .lobby-stats span { font-size: 0.9em; color: #555; }
        .open-games-container { margin-top: 20px; }
        .open-game-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; background-color: #fafafa; }
        .open-game-item .info { text-align: left; flex-grow: 1; }
        .open-game-item .info .creator { font-weight: bold; }
        .open-game-item .info .details { font-size: 0.9em; color: #666; }
        .open-game-item .play-btn, .open-game-item .cancel-btn { white-space: nowrap; margin-left: 10px; }
        .config-form-group { margin-bottom: 15px; }
        .config-form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .time-input-group { display: flex; justify-content: center; align-items: center; gap: 5px; }
        .time-input-group input { width: 50px; text-align: center; }
        .rounds-slider-group { display: flex; justify-content: center; align-items: center; gap: 15px; }
        #config-rounds-slider, #training-rounds-slider { flex-grow: 1; }
        #config-rounds-value, #training-rounds-value { font-weight: bold; font-size: 1.2em; min-width: 25px; }
        .timers-container { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .timer-box { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 48%; }
        .timer-box.active-turn { border-color: #007bff; box-shadow: 0 0 5px rgba(0,123,255,0.5); }
        .timer-value { font-size: 1.5em; font-weight: bold; }
        .live-named-list { max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; margin-bottom: 10px; text-align: left; }
        .player-name { padding: 2px 5px; }
        .rating-positive { color: green; }
        .rating-negative { color: red; }
        #leaderboard-table, #game-history-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        #leaderboard-table th, #leaderboard-table td, #game-history-table th, #game-history-table td { padding: 8px; border: 1px solid #ddd; }
        #leaderboard-table th, #game-history-table th { background-color: #f2f2f2; }
        .summary-columns { display: flex; justify-content: space-around; text-align: left; margin: 15px 0; }
        .summary-column { width: 45%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #f9f9f9; }
        .summary-column h4 { margin-top: 0; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #ddd; }
        .player-name-list { max-height: 150px; overflow-y: auto; text-align: left;}
        .player-name-list .player-name { padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; background-color: #fff; border: 1px solid #eee;}
        .main-buttons { margin-bottom: 20px; }
        .clubs-selection-container {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        .clubs-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: left;
            margin-top: 10px;
        }
        .club-item {
            display: block;
            margin-bottom: 8px;
        }
        .club-item input {
            margin-right: 10px;
        }
        .clubs-actions {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="auth-screen" class="container">
        <div id="login-form-container">
            <h1>Вход</h1>
            <form id="login-form">
                <input type="text" id="login-nickname" placeholder="Никнейм" autocomplete="username">
                <input type="password" id="login-password" placeholder="Пароль" autocomplete="current-password">
                <button type="submit">Войти</button>
            </form>
            <div id="login-status" class="error-message"></div>
            <p class="auth-toggle" id="show-register-form">Нет аккаунта? Зарегистрироваться</p>
        </div>
        <div id="register-form-container" class="hidden">
            <h1>Регистрация</h1>
            <form id="register-form">
                <input type="text" id="register-nickname" placeholder="Придумайте никнейм" autocomplete="nickname">
                <input type="password" id="register-password" placeholder="Придумайте пароль" autocomplete="new-password">
                <button type="submit">Создать аккаунт</button>
            </form>
            <div id="register-status" class="error-message"></div>
            <p class="auth-toggle" id="show-login-form">Уже есть аккаунт? Войти</p>
        </div>
    </div>

    <div id="lobby-screen" class="container hidden">
        <div class="lobby-header">
            <p style="margin:0;">Привет, <b id="welcome-nickname"></b>!</p>
            <button id="logout-btn" class="btn-secondary" style="font-size:0.8em; padding: 6px 12px;">Выйти</button>
        </div>
        <div class="lobby-stats">
            <span>Игроков в лобби: <b id="online-players-count">0</b></span>
            <span>Активных игр: <b id="active-games-count">0</b></span>
        </div>
        <div class="main-buttons">
            <button id="create-game-btn">Создать игру</button>
            <button id="leaderboard-btn">Рейтинг</button>
        </div>
        <button id="training-btn" class="btn-secondary">Тренировка</button>
        <div class="open-games-container">
            <h3>Открытые игры:</h3>
            <div id="open-games-list"><p>Нет открытых игр. Создайте свою!</p></div>
        </div>
    </div>
    
    <div id="config-screen" class="container hidden">
        <h2>Настройки PvP Игры</h2>
        <div class="config-form-group">
            <label for="config-league">Лига</label>
            <input type="text" id="config-league" value="РПЛ" disabled>
        </div>
        <div class="config-form-group">
            <label>Время на раунд</label>
            <div class="time-input-group">
                <input type="number" id="config-time-min" value="1" min="0" max="10">
                <span>:</span>
                <input type="number" id="config-time-sec" value="30" min="0" max="59">
            </div>
        </div>
        <div class="config-form-group">
            <label>Количество клубов</label>
            <div class="rounds-slider-group">
                <span>3</span>
                <input type="range" id="config-rounds-slider" min="3" max="16" value="16">
                <span id="config-rounds-value">16</span>
            </div>
            <button id="config-select-clubs-btn" class="btn-secondary" style="margin-top: 10px;">Выбрать клубы</button>
        </div>

        <div id="config-clubs-selection" class="clubs-selection-container hidden">
            <h4>Выберите клубы для игры</h4>
            <div class="clubs-actions">
                <button id="config-select-all-clubs">Выбрать все</button>
                <button id="config-deselect-all-clubs">Снять все</button>
            </div>
            <div id="config-clubs-list" class="clubs-list"></div>
            <button id="config-confirm-clubs-btn">Подтвердить выбор</button>
            <button id="config-reset-clubs-btn" class="btn-secondary">Сбросить (к ползунку)</button>
        </div>
        
        <button id="submit-create-game-btn">Создать игру</button>
        <button id="back-to-lobby-btn" class="btn-secondary">Назад</button>
    </div>

    <div id="training-config-screen" class="container hidden">
        <h2>Настройки Тренировки</h2>
        <div class="config-form-group">
            <label>Время на раунд</label>
            <div class="time-input-group">
                <input type="number" id="training-time-min" value="1" min="0" max="10">
                <span>:</span>
                <input type="number" id="training-time-sec" value="30" min="0" max="59">
            </div>
        </div>
        <div class="config-form-group">
            <label>Количество клубов</label>
            <div class="rounds-slider-group">
                <span>1</span>
                <input type="range" id="training-rounds-slider" min="1" max="16" value="5">
                <span id="training-rounds-value">5</span>
            </div>
            <button id="training-select-clubs-btn" class="btn-secondary" style="margin-top: 10px;">Выбрать клубы</button>
        </div>

        <div id="training-clubs-selection" class="clubs-selection-container hidden">
            <h4>Выберите клубы для тренировки</h4>
            <div class="clubs-actions">
                <button id="training-select-all-clubs">Выбрать все</button>
                <button id="training-deselect-all-clubs">Снять все</button>
            </div>
            <div id="training-clubs-list" class="clubs-list"></div>
            <button id="training-confirm-clubs-btn">Подтвердить выбор</button>
            <button id="training-reset-clubs-btn" class="btn-secondary">Сбросить (к ползунку)</button>
        </div>

        <button id="submit-training-game-btn">Начать тренировку</button>
        <button id="back-to-lobby-from-training-btn" class="btn-secondary">Назад</button>
    </div>
    
    <div id="game-screen" class="container hidden">
        <h2 id="game-header">Тур 1/16: Клуб</h2>
        <h3 id="score-display" class="hidden">Игрок1 0:0 Игрок2</h3>
        <div class="timers-container">
            <div id="my-timer-box" class="timer-box" style="width: 100%;">
                <div id="my-timer-nickname">Вы</div>
                <div id="my-timer-value" class="timer-value">01:30</div>
            </div>
            <div id="opponent-timer-box" class="timer-box hidden">
                <div id="opponent-timer-nickname">Соперник</div>
                <div id="opponent-timer-value" class="timer-value">01:30</div>
            </div>
        </div>
        <div id="game-status">Ваш ход...</div>
        <div class="live-named-list" id="live-named-list"></div>
        <form id="guess-form">
            <input type="text" id="guess-input" placeholder="Введите фамилию..." autocomplete="off">
            <button type="submit" id="submit-guess-btn">Ответить</button>
            <button type="button" id="surrender-btn" class="btn-danger">Сдаться</button>
        </form>
    </div>

    <div id="summary-screen" class="container hidden">
        <h2 id="summary-header">Итоги раунда: Клуб</h2>
        <h3 id="summary-score-display" class="hidden">Счет</h3>
        <div class="summary-columns">
            <div class="summary-column" id="summary-human-column">
                <h4 id="summary-human-name-header">Вы</h4>
                <div class="player-name-list" id="summary-human-named-list"></div>
            </div>
            <div class="summary-column hidden" id="summary-bot-column">
                <h4 id="summary-bot-name-header">Соперник</h4>
                <div class="player-name-list" id="summary-bot-named-list"></div>
            </div>
        </div>
        <h4>Оставшиеся игроки:</h4>
        <div class="player-name-list" id="summary-remaining-list" style="max-height: 100px; margin: 0 auto; width: 90%;"></div>
        <p>Следующий раунд через: <b id="summary-countdown">10</b></p>
        <button id="skip-pause-btn">Пропустить</button>
    </div>

    <div id="leaderboard-screen" class="container hidden">
        <h2>Рейтинг игроков</h2>
        <table id="leaderboard-table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Никнейм</th>
                    <th>Рейтинг</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
            </tbody>
        </table>
        <button id="back-to-lobby-from-leaderboard-btn" class="btn-secondary">Назад</button>
    </div>

    <div id="game-over-screen" class="container hidden">
        <h2 id="game-over-title">🏆 Победил Игрок1!</h2>
        <p id="early-end-explanation" class="hidden">Игра завершена досрочно.</p>
        <h3 id="final-score-display">Игрок1 10 : 6 Игрок2</h3>
        <div id="rating-changes-display" class="hidden" style="margin-bottom: 15px;"></div>
        <div id="game-history-container">
            <h4>История раундов</h4>
            <table id="game-history-table">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
        <button id="back-to-lobby-from-game-over-btn" style="margin-top: 15px;">Вернуться в лобби</button>
    </div>

    <div id="disconnection-modal" class="container hidden" style="position: fixed; z-index: 100; background-color: rgba(255, 255, 255, 0.95);">
        <h2>Соединение потеряно</h2>
        <p id="disconnection-message">Ваш соперник отключился. Игра была отменена, рейтинг не изменен.</p>
        <button id="back-to-lobby-from-disconnect-btn">Вернуться в лобби</button>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        const screens = {
            auth: document.getElementById('auth-screen'),
            lobby: document.getElementById('lobby-screen'),
            config: document.getElementById('config-screen'),
            trainingConfig: document.getElementById('training-config-screen'),
            game: document.getElementById('game-screen'),
            summary: document.getElementById('summary-screen'),
            gameOver: document.getElementById('game-over-screen'),
            leaderboard: document.getElementById('leaderboard-screen'),
            disconnection: document.getElementById('disconnection-modal'),
        };

        // --- Элементы DOM ---
        const loginForm = document.getElementById('login-form'), loginNickname = document.getElementById('login-nickname'), loginPassword = document.getElementById('login-password'), loginStatus = document.getElementById('login-status');
        const registerForm = document.getElementById('register-form'), registerNickname = document.getElementById('register-nickname'), registerPassword = document.getElementById('register-password'), registerStatus = document.getElementById('register-status');
        const showRegisterFormBtn = document.getElementById('show-register-form'), showLoginFormBtn = document.getElementById('show-login-form');
        
        const welcomeNickname = document.getElementById('welcome-nickname'), logoutBtn = document.getElementById('logout-btn');
        const createGameBtn = document.getElementById('create-game-btn'), leaderboardBtn = document.getElementById('leaderboard-btn');
        const trainingBtn = document.getElementById('training-btn');
        const openGamesList = document.getElementById('open-games-list');
        const onlinePlayersCount = document.getElementById('online-players-count');
        const activeGamesCount = document.getElementById('active-games-count');
        
        const configTimeMin = document.getElementById('config-time-min'), configTimeSec = document.getElementById('config-time-sec');
        const backToLobbyBtn = document.getElementById('back-to-lobby-btn'), submitCreateGameBtn = document.getElementById('submit-create-game-btn');
        const configRoundsSlider = document.getElementById('config-rounds-slider'), configRoundsValue = document.getElementById('config-rounds-value');

        const trainingTimeMin = document.getElementById('training-time-min'), trainingTimeSec = document.getElementById('training-time-sec');
        const backToLobbyFromTrainingBtn = document.getElementById('back-to-lobby-from-training-btn'), submitTrainingGameBtn = document.getElementById('submit-training-game-btn');
        const trainingRoundsSlider = document.getElementById('training-rounds-slider'), trainingRoundsValue = document.getElementById('training-rounds-value');

        const gameHeader = document.getElementById('game-header'), scoreDisplay = document.getElementById('score-display'), gameStatus = document.getElementById('game-status'), guessForm = document.getElementById('guess-form'), guessInput = document.getElementById('guess-input'), liveNamedList = document.getElementById('live-named-list'), surrenderBtn = document.getElementById('surrender-btn'), submitGuessBtn = document.getElementById('submit-guess-btn');
        const myTimerBox = document.getElementById('my-timer-box'), myTimerNickname = document.getElementById('my-timer-nickname'), myTimerValue = document.getElementById('my-timer-value');
        const opponentTimerBox = document.getElementById('opponent-timer-box'), opponentTimerNickname = document.getElementById('opponent-timer-nickname'), opponentTimerValue = document.getElementById('opponent-timer-value');
        
        const summaryHeader = document.getElementById('summary-header'), summaryScoreDisplay = document.getElementById('summary-score-display'), summaryHumanColumn = document.getElementById('summary-human-column'), summaryBotColumn = document.getElementById('summary-bot-column'), summaryHumanNameHeader = document.getElementById('summary-human-name-header'), summaryBotNameHeader = document.getElementById('summary-bot-name-header'), summaryHumanNamedList = document.getElementById('summary-human-named-list'), summaryBotNamedList = document.getElementById('summary-bot-named-list'), summaryRemainingList = document.getElementById('summary-remaining-list'), summaryCountdown = document.getElementById('summary-countdown'), skipPauseBtn = document.getElementById('skip-pause-btn');

        const leaderboardBody = document.getElementById('leaderboard-body'), backToLobbyFromLeaderboardBtn = document.getElementById('back-to-lobby-from-leaderboard-btn');
        const gameOverTitle = document.getElementById('game-over-title'), earlyEndExplanation = document.getElementById('early-end-explanation'), finalScoreDisplay = document.getElementById('final-score-display'), ratingChangesDisplay = document.getElementById('rating-changes-display'), backToLobbyFromGameOverBtn = document.getElementById('back-to-lobby-from-game-over-btn');
        const gameHistoryContainer = document.getElementById('game-history-container'), gameHistoryTable = document.getElementById('game-history-table');
        const disconnectionModal = document.getElementById('disconnection-modal'), backToLobbyFromDisconnectBtn = document.getElementById('back-to-lobby-from-disconnect-btn');

        // --- Состояние клиента ---
        let currentUserNickname = null;
        let clientState = {};
        let isMyTurn = false;
        let timerInterval, summaryInterval, gameStatusTimeout;
        
        let selectedPvPClubs = null;
        let selectedTrainingClubs = null;

        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen && screen.classList.add('hidden'));
            if (screens[screenName]) screens[screenName].classList.remove('hidden');
        }

        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        
        function updateGameUI(state) {
            clientState = state;
            const isSolo = state.mode === 'solo';
            let myPlayerIndex = -1;
            if (isSolo) {
                myPlayerIndex = 0;
            } else {
                for (const i in state.players) { if (state.players[i].sid === socket.id) { myPlayerIndex = parseInt(i, 10); break; } }
            }
            if (myPlayerIndex === -1) return;
            
            const opponentPlayerIndex = 1 - myPlayerIndex;
            const activePlayerIndex = state.currentPlayerIndex;
            isMyTurn = (myPlayerIndex === activePlayerIndex);

            scoreDisplay.classList.toggle('hidden', isSolo);
            opponentTimerBox.classList.toggle('hidden', isSolo);
            myTimerBox.style.width = isSolo ? '100%' : '48%';

            gameHeader.textContent = `Тур ${state.round}/${state.totalRounds}: ${state.clubName}`;
            if (!isSolo) {
                scoreDisplay.textContent = `${state.players[0].nickname} ${state.scores[0]} : ${state.scores[1]} ${state.players[1].nickname}`;
                opponentTimerNickname.textContent = state.players[opponentPlayerIndex].nickname;
            }
            
            myTimerNickname.textContent = state.players[myPlayerIndex].nickname + (isSolo ? '' : ' (Вы)');
            submitGuessBtn.disabled = !isMyTurn;
            surrenderBtn.disabled = !isMyTurn;
            guessInput.placeholder = 'Введите фамилию...';
            guessInput.disabled = !isMyTurn;

            if(isMyTurn) guessInput.focus();
            
            myTimerBox.classList.toggle('active-turn', isMyTurn);
            if (!isSolo) opponentTimerBox.classList.toggle('active-turn', !isMyTurn);
            
            liveNamedList.innerHTML = '';
            state.namedPlayers.forEach(player => {
                const pDiv = document.createElement('div');
                pDiv.className = 'player-name';
                const author = state.players[player.by] && !isSolo ? ` (${state.players[player.by].nickname})` : '';
                pDiv.textContent = `${player.full_name}${author}`;
                liveNamedList.prepend(pDiv);
            });

            clearInterval(timerInterval);
            let timeBanks = {...state.timeBanks};
            myTimerValue.textContent = formatTime(timeBanks[myPlayerIndex]);
            if (!isSolo && state.players[opponentPlayerIndex]) {
                opponentTimerValue.textContent = formatTime(timeBanks[opponentPlayerIndex]);
            }
            
            timerInterval = setInterval(() => {
                timeBanks[activePlayerIndex] -= 0.1;
                const activeTimerDisplay = (activePlayerIndex === myPlayerIndex) ? myTimerValue : opponentTimerValue;
                if(activeTimerDisplay) activeTimerDisplay.textContent = formatTime(timeBanks[activePlayerIndex]);
                if (timeBanks[activePlayerIndex] <= 0) clearInterval(timerInterval);
            }, 100);
        }
        
        function setupClubSelector(configPrefix) {
            const selectClubsBtn = document.getElementById(`${configPrefix}-select-clubs-btn`);
            const clubsSelectionDiv = document.getElementById(`${configPrefix}-clubs-selection`);
            const roundsSlider = document.getElementById(`${configPrefix}-rounds-slider`);
            const selectAllBtn = document.getElementById(`${configPrefix}-select-all-clubs`);
            const deselectAllBtn = document.getElementById(`${configPrefix}-deselect-all-clubs`);
            const confirmBtn = document.getElementById(`${configPrefix}-confirm-clubs-btn`);
            const resetBtn = document.getElementById(`${configPrefix}-reset-clubs-btn`);
            const clubsListDiv = document.getElementById(`${configPrefix}-clubs-list`);

            const isPvp = configPrefix === 'config';
            const minClubs = isPvp ? 3 : 1;

            selectClubsBtn.addEventListener('click', () => {
                clubsSelectionDiv.classList.remove('hidden');
                roundsSlider.disabled = true;
                selectClubsBtn.disabled = true;
            });

            resetBtn.addEventListener('click', () => {
                clubsSelectionDiv.classList.add('hidden');
                roundsSlider.disabled = false;
                selectClubsBtn.disabled = false;
                selectClubsBtn.textContent = 'Выбрать клубы';
                if (isPvp) selectedPvPClubs = null;
                else selectedTrainingClubs = null;
            });

            selectAllBtn.addEventListener('click', () => {
                clubsListDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            });

            deselectAllBtn.addEventListener('click', () => {
                clubsListDiv.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            });

            confirmBtn.addEventListener('click', () => {
                const selected = Array.from(clubsListDiv.querySelectorAll('input:checked')).map(cb => cb.value);
                
                if (selected.length < minClubs) {
                    alert(`Нужно выбрать как минимум ${minClubs} клуб(а).`);
                    return;
                }
                
                if (isPvp) selectedPvPClubs = selected;
                else selectedTrainingClubs = selected;

                selectClubsBtn.textContent = `Выбрано клубов: ${selected.length}`;
                selectClubsBtn.disabled = false; // Позволяем снова открыть для редактирования
                clubsSelectionDiv.classList.add('hidden');
            });
        }

        setupClubSelector('config');
        setupClubSelector('training');

        // --- Обработчики событий ---
        showRegisterFormBtn.addEventListener('click', () => { document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('register-form-container').classList.remove('hidden'); });
        showLoginFormBtn.addEventListener('click', () => { document.getElementById('register-form-container').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); });

        loginForm.addEventListener('submit', e => { e.preventDefault(); loginStatus.textContent = "Проверка..."; socket.emit('login_user', { nickname: loginNickname.value.trim(), password: loginPassword.value }); });
        registerForm.addEventListener('submit', e => { e.preventDefault(); registerStatus.textContent = "Создание аккаунта..."; socket.emit('register_user', { nickname: registerNickname.value.trim(), password: registerPassword.value }); });
        logoutBtn.addEventListener('click', () => {
            currentUserNickname = null;
            localStorage.removeItem('rpl_quiz_nickname');
            showScreen('auth');
        });

        createGameBtn.addEventListener('click', () => showScreen('config'));
        trainingBtn.addEventListener('click', () => showScreen('trainingConfig'));
        backToLobbyBtn.addEventListener('click', () => showScreen('lobby'));
        backToLobbyFromTrainingBtn.addEventListener('click', () => showScreen('lobby'));
        leaderboardBtn.addEventListener('click', () => { socket.emit('get_leaderboard'); showScreen('leaderboard'); });
        backToLobbyFromGameOverBtn.addEventListener('click', () => showScreen('lobby'));
        backToLobbyFromLeaderboardBtn.addEventListener('click', () => showScreen('lobby'));
        backToLobbyFromDisconnectBtn.addEventListener('click', () => { showScreen('lobby'); disconnectionModal.classList.add('hidden'); });

        submitCreateGameBtn.addEventListener('click', () => {
            const timeBank = parseInt(configTimeMin.value) * 60 + parseInt(configTimeSec.value);
            if (isNaN(timeBank) || timeBank <= 0) { alert("Пожалуйста, введите корректное время."); return; }
            const settings = { 
                time_bank: timeBank, 
                num_rounds: selectedPvPClubs ? selectedPvPClubs.length : parseInt(configRoundsSlider.value),
                selected_clubs: selectedPvPClubs // Будет null, если используется слайдер
            };
            socket.emit('create_game', { nickname: currentUserNickname, settings: settings });
            showScreen('lobby');
        });

        submitTrainingGameBtn.addEventListener('click', () => {
            const timeBank = parseInt(trainingTimeMin.value) * 60 + parseInt(trainingTimeSec.value);
            if (isNaN(timeBank) || timeBank <= 0) { alert("Пожалуйста, введите корректное время."); return; }
            const settings = { 
                time_bank: timeBank, 
                num_rounds: selectedTrainingClubs ? selectedTrainingClubs.length : parseInt(trainingRoundsSlider.value),
                selected_clubs: selectedTrainingClubs // Будет null, если используется слайдер
            };
            socket.emit('start_game', { mode: 'solo', nickname: currentUserNickname, settings: settings });
        });
        
        configRoundsSlider.addEventListener('input', (e) => { configRoundsValue.textContent = e.target.value; });
        trainingRoundsSlider.addEventListener('input', (e) => { trainingRoundsValue.textContent = e.target.value; });

        guessForm.addEventListener('submit', (e) => { e.preventDefault(); if (isMyTurn) { const guess = guessInput.value; if (guess) { socket.emit('submit_guess', { roomId: clientState.roomId, guess: guess }); guessInput.value = ''; } } });
        surrenderBtn.addEventListener('click', () => { if (!surrenderBtn.disabled) socket.emit('surrender_round', { roomId: clientState.roomId }); });
        skipPauseBtn.addEventListener('click', () => { skipPauseBtn.disabled = true; socket.emit('request_skip_pause', { roomId: clientState.roomId }); });

        openGamesList.addEventListener('click', e => {
            if (e.target.classList.contains('play-btn')) {
                const creatorSid = e.target.dataset.creatorSid;
                if (currentUserNickname) {
                    socket.emit('join_game', { creator_sid: creatorSid, nickname: currentUserNickname });
                }
            } else if (e.target.classList.contains('cancel-btn')) {
                socket.emit('cancel_game');
            }
        });

        // --- Обработчики Socket.IO ---
        socket.on('auth_status', data => {
            const statusDiv = document.getElementById(`${data.form}-status`);
            if (data.success) {
                currentUserNickname = data.nickname;
                localStorage.setItem('rpl_quiz_nickname', currentUserNickname);
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
                socket.emit('get_league_clubs', { league: 'РПЛ' });
            } else { if (statusDiv) statusDiv.textContent = data.message; }
        });

        socket.on('update_lobby', data => {
            openGamesList.innerHTML = '';
            let userHasOpenGame = false;
            if (!data || data.length === 0) {
                openGamesList.innerHTML = '<p>Нет открытых игр. Создайте свою!</p>';
            } else {
                data.forEach(game => {
                    if (game.creator_sid === socket.id) { userHasOpenGame = true; }
                    const gameItem = document.createElement('div');
                    gameItem.className = 'open-game-item';
                    const time_str = `${Math.floor(game.settings.time_bank / 60)}:${String(game.settings.time_bank % 60).padStart(2, '0')}`;
                    const buttonHtml = game.creator_sid === socket.id ? `<button class="cancel-btn btn-danger">Отменить</button>` : `<button class="play-btn" data-creator-sid="${game.creator_sid}">Играть</button>`;
                    const roundsText = game.settings.selected_clubs ? `${game.settings.selected_clubs.length} раундов (выбраны)` : `${game.settings.num_rounds} раундов`;
                    gameItem.innerHTML = `<div class="info"><span class="creator">${game.creator_nickname} (${game.creator_rating})</span><div class="details">РПЛ, ${roundsText}, ${time_str}</div></div>${buttonHtml}`;
                    openGamesList.appendChild(gameItem);
                });
            }
            createGameBtn.disabled = userHasOpenGame;
        });
        
        socket.on('update_lobby_stats', (data) => {
            onlinePlayersCount.textContent = data.online_players;
            activeGamesCount.textContent = data.active_games;
        });

        socket.on('league_clubs_data', (data) => {
            const configListDiv = document.getElementById('config-clubs-list');
            const trainingListDiv = document.getElementById('training-clubs-list');
            configListDiv.innerHTML = '';
            trainingListDiv.innerHTML = '';

            data.clubs.forEach(clubName => {
                const itemHtml = `<label class="club-item"><input type="checkbox" value="${clubName}">${clubName}</label>`;
                configListDiv.innerHTML += itemHtml;
                trainingListDiv.innerHTML += itemHtml;
            });
            
            const numberOfClubs = data.clubs.length;
            if (numberOfClubs > 0) {
                configRoundsSlider.max = numberOfClubs;
                configRoundsSlider.value = numberOfClubs; 
                configRoundsValue.textContent = numberOfClubs;

                trainingRoundsSlider.max = numberOfClubs;
                const trainingDefaultValue = Math.min(5, numberOfClubs);
                trainingRoundsSlider.value = trainingDefaultValue;
                trainingRoundsValue.textContent = trainingDefaultValue;
            }
        });

        socket.on('leaderboard_data', (data) => {
            leaderboardBody.innerHTML = '';
            data.forEach((user, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${index + 1}</td><td>${user.nickname}</td><td>${user.rating}</td>`;
                leaderboardBody.appendChild(row);
            });
        });

        socket.on('round_started', (state) => {
            clearInterval(summaryInterval);
            showScreen('game');
            updateGameUI(state);
        });

        socket.on('turn_updated', (state) => {
            updateGameUI(state);
        });
        
        socket.on('guess_result', (data) => {
            clearTimeout(gameStatusTimeout);
            let message = '';
            switch(data.result) {
                case 'correct': message = '✅ Верно!'; break;
                case 'correct_typo': message = `✅ Верно! (Засчитано как: ${data.corrected_name})`; break;
                case 'already_named': message = 'Такого уже называли!'; break;
                default: message = '❌ Неверно!';
            }
            gameStatus.textContent = message;
            gameStatusTimeout = setTimeout(() => {
                if (Object.keys(clientState).length > 0 && clientState.players[clientState.currentPlayerIndex]) {
                    const currentTurnPlayer = clientState.players[clientState.currentPlayerIndex];
                    gameStatus.textContent = isMyTurn ? 'Ваш ход...' : `Ожидаем ход игрока ${currentTurnPlayer.nickname}...`;
                }
            }, 2000);
        });

        socket.on('round_summary', (data) => {
            const isSolo = data.mode === 'solo';
            showScreen('summary');
            skipPauseBtn.disabled = false;
            skipPauseBtn.textContent = 'Пропустить';
            summaryHeader.textContent = `Итоги раунда: ${data.clubName}`;
            
            summaryScoreDisplay.classList.toggle('hidden', isSolo);
            summaryBotColumn.classList.toggle('hidden', isSolo);

            if (!isSolo) {
                summaryScoreDisplay.textContent = `${data.players[0].nickname} ${data.scores[0]} : ${data.scores[1]} ${data.players[1].nickname}`;
                summaryBotNameHeader.textContent = data.players[1].nickname;
            }
            summaryHumanNameHeader.textContent = data.players[0].nickname;
            
            summaryHumanNamedList.innerHTML = ''; 
            summaryBotNamedList.innerHTML = ''; 
            summaryRemainingList.innerHTML = '';
            
            const allNamedPlayerNames = new Set(data.namedPlayers.map(p => p.full_name));
            
            data.namedPlayers.forEach(player => {
                const pDiv = document.createElement('div');
                pDiv.className = 'player-name';
                pDiv.textContent = player.full_name;
                if (player.by === 0) summaryHumanNamedList.appendChild(pDiv);
                else summaryBotNamedList.appendChild(pDiv);
            });
            
            data.fullPlayerList.forEach(playerName => {
                if (!allNamedPlayerNames.has(playerName)) {
                    const pDiv = document.createElement('div');
                    pDiv.className = 'player-name';
                    pDiv.textContent = playerName;
                    summaryRemainingList.appendChild(pDiv);
                }
            });

            let countdown = 10;
            summaryCountdown.textContent = countdown;
            clearInterval(summaryInterval);
            summaryInterval = setInterval(() => {
                countdown--;
                summaryCountdown.textContent = countdown >= 0 ? countdown : 0;
                if (countdown < 0) clearInterval(summaryInterval);
            }, 1000);
        });

        socket.on('game_over', (data) => {
            if (data.mode === 'solo') {
                showScreen('lobby');
                return;
            }
            showScreen('gameOver');
            const player1Name = data.players[0].nickname;
            const player2Name = data.players[1].nickname;
            if (data.final_scores[0] > data.final_scores[1]) { gameOverTitle.textContent = `🏆 Победил ${player1Name}!`; } 
            else if (data.final_scores[1] > data.final_scores[0]) { gameOverTitle.textContent = `🏆 Победил ${player2Name}!`; } 
            else { gameOverTitle.textContent = "🤝 Ничья!"; }
            earlyEndExplanation.classList.toggle('hidden', data.end_reason !== 'unreachable_score');
            finalScoreDisplay.textContent = `${player1Name} ${data.final_scores[0]} : ${data.final_scores[1]} ${player2Name}`;
            
            if (data.mode === 'pvp' && data.rating_changes) {
                const p1_change = data.rating_changes.p1.new - data.rating_changes.p1.old;
                const p2_change = data.rating_changes.p2.new - data.rating_changes.p2.old;
                const p1_sign = p1_change >= 0 ? '+' : ''; const p2_sign = p2_change >= 0 ? '+' : '';
                ratingChangesDisplay.innerHTML = `<div class="rating-change">${player1Name}: ${data.rating_changes.p1.old} → ${data.rating_changes.p1.new} (<span class="${p1_change >= 0 ? 'rating-positive' : 'rating-negative'}">${p1_sign}${p1_change}</span>)</div><div class="rating-change">${player2Name}: ${data.rating_changes.p2.old} → ${data.rating_changes.p2.new} (<span class="${p2_change >= 0 ? 'rating-positive' : 'rating-negative'}">${p2_sign}${p2_change}</span>)</div>`;
                ratingChangesDisplay.classList.remove('hidden');
            } else {
                ratingChangesDisplay.classList.add('hidden');
            }

            const tableHead = gameHistoryTable.querySelector('thead');
            const tableBody = gameHistoryTable.querySelector('tbody');
            tableHead.innerHTML = `<tr><th>Клуб</th><th>${player1Name}</th><th>${player2Name}</th><th>Причина</th></tr>`;
            tableBody.innerHTML = '';
            if (data.history && data.history.length > 0) {
                gameHistoryContainer.classList.remove('hidden');
                data.history.forEach(round => {
                    const row = document.createElement('tr');
                    let reasonText = '';
                    switch(round.result_type) {
                        case 'completed': reasonText = 'Завершен'; break;
                        case 'timeout': reasonText = `Время вышло (${round.player_nickname})`; break;
                        case 'surrender': reasonText = `Сдался (${round.player_nickname})`; break;
                        default: reasonText = '---';
                    }
                    row.innerHTML = `<td>${round.club_name}</td><td>${round.p1_named}</td><td>${round.p2_named}</td><td>${reasonText}</td>`;
                    tableBody.appendChild(row);
                });
            } else {
                gameHistoryContainer.classList.add('hidden');
            }
        });

        socket.on('opponent_disconnected', (data) => {
            clearInterval(timerInterval);
            clearInterval(summaryInterval);
            document.getElementById('disconnection-message').textContent = data.message;
            showScreen('disconnection');
        });

        // Инициализация
        window.addEventListener('load', () => {
            const savedNickname = localStorage.getItem('rpl_quiz_nickname');
            if (savedNickname) {
                currentUserNickname = savedNickname;
                welcomeNickname.textContent = currentUserNickname;
                showScreen('lobby');
                socket.emit('get_league_clubs', { league: 'РПЛ' });
            } else { 
                showScreen('auth'); 
            }
        });
    </script>
</body>
</html>