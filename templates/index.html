<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Футбольная игра</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a; --primary-color: #2c2c2c; --secondary-color: #444;
            --text-color: #f0f0f0; --accent-color: #0088cc; --accent-hover-color: #00aaff;
            --correct-color: #28a745; --incorrect-color: #dc3545; --cancel-color: #aa4a44;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }
        .screen { display: none; width: 100%; height: 100%; overflow-y: auto; box-sizing: border-box; padding: 15px; }
        .screen.active { display: flex; flex-direction: column; align-items: center; }
        button { background-color: var(--accent-color); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.2s; }
        button:hover { background-color: var(--accent-hover-color); }
        button:disabled { background-color: var(--secondary-color); cursor: not-allowed; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--secondary-color); background-color: var(--primary-color); color: var(--text-color); font-size: 16px; box-sizing: border-box; }
        /* --- ИСПРАВЛЕНИЕ: стиль для НЕзаблокированного инпута (Request 1) --- */
        input[type="text"]:disabled { background-color: #222; } /* Остается на случай */
        .container { width: 100%; max-width: 600px; margin: 0 auto; text-align: center; }
        #loading-screen { justify-content: center; }
        .loader { border: 8px solid var(--secondary-color); border-top: 8px solid var(--accent-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #nickname-screen .container { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        #lobby-screen h1 { margin-top: 0; }
        .game-card { background-color: var(--primary-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .game-card-info p { margin: 4px 0; }
        #settings-screen .container { text-align: left; }
        #game-screen .game-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 15px; }
        .player-info { padding: 5px; border-radius: 4px; }
        .player-info.active { box-shadow: 0 2px 0 var(--accent-color); }
        #named-players-list { list-style: none; padding: 0; max-height: 40vh; overflow-y: auto; margin: 15px 0; text-align: left; }
        #leaderboard-screen table, #game-over-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #leaderboard-screen th, #leaderboard-screen td, #game-over-table th, #game-over-table td { padding: 10px; border-bottom: 1px solid var(--secondary-color); text-align: left; }
        #game-over-table th { background-color: var(--primary-color); }
        
        .cancel-btn { background-color: var(--cancel-color); }
        .cancel-btn:hover { background-color: #c45a54; }

        .tabs-container { display: flex; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; background-color: var(--primary-color); border: 1px solid var(--secondary-color); color: var(--text-color); cursor: pointer; border-radius: 0; }
        .tab-btn:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .tab-btn:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        .tab-btn.active { background-color: var(--accent-color); border-color: var(--accent-color); font-weight: bold; }
        .tab-content { display: none; padding: 15px; background-color: var(--primary-color); border-radius: 8px; }
        .tab-content.active { display: block; }
        #clubs-selection-list { max-height: 200px; overflow-y: auto; border: 1px solid var(--secondary-color); padding: 10px; border-radius: 8px; }
        .club-item { display: block; text-align: left; margin: 5px 0; }
        #settings-error-msg { color: var(--incorrect-color); height: 20px; margin-top: 10px; }

        .button-row { display: flex; gap: 10px; margin-top: 20px; }
        .button-row button { flex: 1; margin: 0; }
        .secondary-btn { background-color: var(--secondary-color); }
        .secondary-btn:hover { background-color: #555; }

        #summary-screen .container { text-align: left; }
        #summary-screen h2, #summary-screen h3, #summary-screen p { text-align: center; }
        .summary-list-wrapper { position: relative; }
        .summary-list-wrapper h4 { text-align: center; }
        #summary-list-container {
            position: relative; max-height: 40vh; overflow-y: auto;
            border: 1px solid var(--secondary-color); border-radius: 8px;
            padding: 10px; background-color: var(--primary-color);
            -webkit-overflow-scrolling: touch;
        }
        .summary-list-wrapper::after {
            content: ''; position: absolute; bottom: 1px; left: 1px; right: 1px;
            height: 30px; background: linear-gradient(to top, var(--primary-color) 0%, rgba(44, 44, 44, 0) 100%);
            pointer-events: none; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;
            transition: opacity 0.3s; opacity: 1;
        }
        .summary-list-wrapper.scrolled-to-bottom::after { opacity: 0; }
        #summary-player-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        
        /* --- НОВЫЙ СТИЛЬ: Таймер на экране Summary (Request 5) --- */
        #summary-countdown {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #game-over-screen .container { text-align: left; }
        #game-over-screen h2, #game-over-screen h3 { text-align: center; }
        #game-over-score { font-size: 24px; font-weight: bold; text-align: center; }
        #game-over-reason { text-align: center; font-style: italic; color: #aaa; }
        #game-over-ratings { text-align: center; margin-top: 15px; margin-bottom: 20px; }
        #game-over-back-btn { width: 100%; margin-top: 20px; }
        
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active"><div class="container"><div class="loader"></div><p>Подключение...</p></div></div>
    <div id="nickname-screen" class="screen"><div class="container"><h2>Добро пожаловать!</h2><p>Придумайте себе уникальный никнейм.</p><input type="text" id="nickname-input" placeholder="Введите ваш никнейм"><button id="submit-nickname-btn">Сохранить</button><p id="nickname-error" style="color: var(--incorrect-color);"></p></div></div>
    <div id="lobby-screen" class="screen"><div class="container"><h1>Лобби</h1><p id="welcome-message"></p><div id="lobby-stats"></div><div class="lobby-actions" style="display: flex; justify-content: space-around; margin-bottom: 20px;"><button id="create-game-btn">Создать игру</button><button id="start-training-btn">Тренировка</button><button id="show-leaderboard-btn">Рейтинг</button></div><h2>Открытые игры:</h2><div id="open-games-list"></div></div></div>
    
    <div id="settings-screen" class="screen">
        <div class="container">
            <h2 id="settings-title">Настройки Игры</h2>
            <div class="setting">
                <label for="league-select">Лига:</label>
                <select id="league-select"><option value="РПЛ">РПЛ</option></select>
            </div>
            <div class="setting">
                <label for="time-bank-input">Тайм-банк (сек):</label>
                <input type="number" id="time-bank-input" value="90" min="30" max="300">
            </div>

            <div class="tabs-container">
                <button class="tab-btn active" data-tab="random">Случайные клубы</button>
                <button class="tab-btn" data-tab="manual">Выбрать вручную</button>
            </div>

            <div id="tab-random" class="tab-content active">
                <label for="random-clubs-slider" id="random-clubs-label">Количество клубов: 10</label>
                <p style="font-size: 12px; color: #aaa;">Игра выберет указанное количество случайных клубов из лиги.</p>
                <input type="range" id="random-clubs-slider" min="3" max="16" value="10" style="width: 100%;">
            </div>

            <div id="tab-manual" class="tab-content">
                <p style="font-size: 12px; color: #aaa;">Выберите от 3 до <span id="max-clubs-count">16</span> клубов для игры.</p>
                <p id="manual-clubs-count" style="font-weight: bold;">Выбрано: 0</p>
                <div id="clubs-selection-list"></div>
            </div>

            <p id="settings-error-msg"></p>
            
            <div class="button-row">
                <button id="back-to-lobby-btn" class="secondary-btn">Назад</button>
                <button id="confirm-create-game-btn" disabled>Создать PvP Игру</button>
                <button id="confirm-training-btn" style="display: none;" disabled>Начать Тренировку</button>
            </div>
        </div>
    </div>
    
    <div id="game-screen" class="screen">
        <div class="container">
            <div class="game-header">
                <div class="player-info" id="player-0-info"><div class="nickname">...</div><div class="time-bank">...</div><div class="score">...</div></div>
                <div id="round-info">...</div>
                <div class="player-info" id="player-1-info"><div class="nickname">...</div><div class="time-bank">...</div><div class="score">...</div></div>
            </div>
            <h2 id="club-name-display">Клуб...</h2>
            <ul id="named-players-list"></ul>
            <p id="guess-result-msg" style="height: 20px;"></p>
            <input type="text" id="guess-input" placeholder="Введите фамилию игрока">
            <button id="submit-guess-btn">Ответить</button>
            <button id="surrender-btn" style="background-color: var(--cancel-color);">Сдаться</button>
        </div>
    </div>

    <div id="summary-screen" class="screen">
        <div class="container">
            <h2 id="summary-title">Раунд завершен!</h2>
            <h3 id="summary-club-name"></h3>
            <p><strong>Текущий счет: <span id="summary-score"></span></strong></p>
            
            <div class="summary-list-wrapper">
                <h4>Весь состав:</h4>
                <div id="summary-list-container">
                    <ul id="summary-player-list"></ul>
                </div>
            </div>
            
            <p id="summary-countdown">10</p> 
            
            <button id="skip-pause-btn" style="width: 100%; margin-top: 10px;">Следующий раунд</button>
        </div>
    </div>
    
    <div id="leaderboard-screen" class="screen">
        <div class="container">
            <h2>Таблица Лидеров</h2>
            <table id="leaderboard-table">
                <thead><tr><th>#</th><th>Никнейм</th><th>Рейтинг</th><th>Игр сыграно</th></tr></thead>
                <tbody></tbody>
            </table>
            <button id="leaderboard-back-btn">Назад</button>
        </div>
    </div>

    <div id="game-over-screen" class="screen">
        <div class="container">
            <h2>Игра окончена!</h2>
            <p id="game-over-score">Счет 0 - 0</p>
            <p id="game-over-reason">Причина...</p>
            <p id="game-over-ratings">Изменение рейтинга...</p>
            
            <h3>История раундов</h3>
            <table id="game-over-table">
                <thead>
                    <tr>
                        <th>Раунд</th>
                        <th>Клуб</th>
                        <th>Итог</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            
            <button id="game-over-back-btn">В лобби</button>
        </div>
    </div>


    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            let localState = { 
                nickname: null, telegramId: null, currentRoomId: null, 
                myPlayerIndex: null, maxClubsInLeague: 16
            };
            let gameTimerInterval = null; 
            // --- НОВЫЙ ТАЙМЕР: Для экрана Summary (Request 5) ---
            let summaryCountdownInterval = null; 
            
            const screens = {
                loading: document.getElementById('loading-screen'),
                nickname: document.getElementById('nickname-screen'),
                lobby: document.getElementById('lobby-screen'),
                settings: document.getElementById('settings-screen'),
                game: document.getElementById('game-screen'),
                summary: document.getElementById('summary-screen'),
                leaderboard: document.getElementById('leaderboard-screen'),
                gameOver: document.getElementById('game-over-screen')
            };

            const settingsTitle = document.getElementById('settings-title');
            const confirmCreateBtn = document.getElementById('confirm-create-game-btn');
            const confirmTrainingBtn = document.getElementById('confirm-training-btn');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const randomClubsSlider = document.getElementById('random-clubs-slider');
            const randomClubsLabel = document.getElementById('random-clubs-label');
            const clubsSelectionList = document.getElementById('clubs-selection-list');
            const manualClubsCount = document.getElementById('manual-clubs-count');
            const settingsErrorMsg = document.getElementById('settings-error-msg');
            const maxClubsCountSpan = document.getElementById('max-clubs-count');
            const openGamesList = document.getElementById('open-games-list');
            const summaryListContainer = document.getElementById('summary-list-container');
            const gameOverBackBtn = document.getElementById('game-over-back-btn');
            // --- НОВЫЙ ЭЛЕМЕНТ: Дисплей таймера (Request 5) ---
            const summaryCountdownDisplay = document.getElementById('summary-countdown');


            summaryListContainer.addEventListener('scroll', () => {
                const wrapper = summaryListContainer.parentElement;
                const isAtBottom = summaryListContainer.scrollHeight - summaryListContainer.scrollTop <= summaryListContainer.clientHeight + 1;
                wrapper.classList.toggle('scrolled-to-bottom', isAtBottom);
            });

            gameOverBackBtn.addEventListener('click', () => showScreen('lobby'));

            function showScreen(screenName) {
                // Очищаем таймер summary, если уходим с него
                if (summaryCountdownInterval) {
                    clearInterval(summaryCountdownInterval);
                    summaryCountdownInterval = null;
                }
                const screenKey = Object.keys(screens).find(key => screens[key] === document.getElementById(`${screenName}-screen`)) || screenName;
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenKey].classList.add('active');
            }

            // --- ОБРАБОТЧИКИ СОБЫТИЙ ---

            socket.on('auth_request', () => tg.initData && socket.emit('login_with_telegram', { initData: tg.initData }));
            socket.on('request_nickname', (data) => { localState.telegramId = data.telegram_id; showScreen('nickname'); });
            socket.on('auth_status', (data) => {
                if (data.success) {
                    localState.nickname = data.nickname;
                    document.getElementById('welcome-message').textContent = `Добро пожаловать, ${localState.nickname}!`;
                    showScreen('lobby');
                } else {
                    document.getElementById('nickname-error').textContent = data.message || 'Ошибка аутентификации.';
                }
            });

            // --- ИСПРАВЛЕНИЕ: ДОБАВЛЕН ЗАПУСК ТАЙМЕРА (Request 5) ---
            socket.on('round_summary', (data) => {
                if (gameTimerInterval) clearInterval(gameTimerInterval); 
                
                summaryListContainer.parentElement.classList.remove('scrolled-to-bottom');
                summaryListContainer.scrollTop = 0; 
                
                document.getElementById('summary-club-name').textContent = data.clubName;
                const p1_score = data.scores[0] || 0;
                const p2_score = data.scores[1] || 0;
                document.getElementById('summary-score').textContent = `${p1_score} - ${p2_score}`;

                const summaryList = document.getElementById('summary-player-list');
                summaryList.innerHTML = '';
                
                data.fullPlayerList.forEach(fullName => {
                    const li = document.createElement('li');
                    const namedPlayer = data.namedPlayers.find(p => p.full_name === fullName);
                    if (namedPlayer) {
                        const authorNickname = data.players[namedPlayer.by].nickname;
                        li.innerHTML = `✅ ${fullName} (<em>${authorNickname}</em>)`;
                        li.style.color = 'var(--correct-color)';
                    } else {
                        li.innerHTML = `❌ ${fullName}`;
                        li.style.color = 'var(--text-color)';
                    }
                    summaryList.appendChild(li);
                });

                document.getElementById('skip-pause-btn').textContent = 'Следующий раунд';
                document.getElementById('skip-pause-btn').disabled = false;
                
                // Запускаем таймер
                let countdown = 10; // Берем из константы сервера PAUSE_BETWEEN_ROUNDS
                summaryCountdownDisplay.textContent = countdown;
                if (summaryCountdownInterval) clearInterval(summaryCountdownInterval); // Очищаем старый, если есть
                summaryCountdownInterval = setInterval(() => {
                    countdown--;
                    summaryCountdownDisplay.textContent = countdown;
                    if (countdown <= 0) {
                        clearInterval(summaryCountdownInterval);
                        summaryCountdownInterval = null;
                        // Можно добавить текст "Загрузка..."
                    }
                }, 1000);
                
                showScreen('summary');
            });

            // --- ИСПРАВЛЕНИЕ: ОСТАНАВЛИВАЕМ ТАЙМЕР ПРИ СКИПЕ (Request 5) ---
            document.getElementById('skip-pause-btn').addEventListener('click', () => {
                if (summaryCountdownInterval) {
                    clearInterval(summaryCountdownInterval);
                    summaryCountdownInterval = null;
                }
                socket.emit('request_skip_pause', { roomId: localState.currentRoomId });
                document.getElementById('skip-pause-btn').disabled = true;
                document.getElementById('skip-pause-btn').textContent = 'Ожидаем...';
            });

            socket.on('skip_vote_update', (data) => {
                document.getElementById('skip-pause-btn').textContent = `Следующий раунд (${data.count}/2)`;
            });

            socket.on('round_started', (state) => {
                showScreen('game');
                updateGameUI(state);
            });
            
            function updateGameUI(state) {
                if (gameTimerInterval) clearInterval(gameTimerInterval);

                localState.currentRoomId = state.roomId;
                localState.myPlayerIndex = -1;
                for (const index in state.players) {
                    if (state.players[index].nickname === localState.nickname) {
                        localState.myPlayerIndex = parseInt(index); break;
                    }
                }
                
                document.getElementById('round-info').textContent = `Раунд ${state.round}/${state.totalRounds}`;
                document.getElementById('club-name-display').textContent = state.clubName;
                
                for (let i = 0; i < 2; i++) {
                    const playerInfoEl = document.getElementById(`player-${i}-info`);
                    if (state.players[i]) {
                        playerInfoEl.style.display = 'block';
                        playerInfoEl.querySelector('.nickname').textContent = state.players[i].nickname;
                        playerInfoEl.querySelector('.score').textContent = state.scores[i] || 0;
                        
                        const timeBankEl = playerInfoEl.querySelector('.time-bank');
                        let timeLeft = state.timeBanks[i] || 0;
                        timeBankEl.textContent = `${timeLeft.toFixed(1)}с`;

                        playerInfoEl.classList.toggle('active', i === state.currentPlayerIndex);

                        if (i === state.currentPlayerIndex && timeLeft > 0) {
                            gameTimerInterval = setInterval(() => {
                                timeLeft -= 0.1;
                                if (timeLeft < 0) timeLeft = 0;
                                timeBankEl.textContent = `${timeLeft.toFixed(1)}с`;
                                if (timeLeft <= 0) {
                                    clearInterval(gameTimerInterval);
                                }
                            }, 100);
                        }
                    } else {
                        playerInfoEl.style.display = 'none';
                    }
                }
                
                const namedPlayersList = document.getElementById('named-players-list');
                namedPlayersList.innerHTML = '';
                state.namedPlayers.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.full_name} (${state.players[p.by].nickname})`;
                    namedPlayersList.appendChild(li);
                });
                
                const myTurn = state.currentPlayerIndex === localState.myPlayerIndex;
                const guessInput = document.getElementById('guess-input');
                
                guessInput.disabled = false; // Поле ввода ВСЕГДА активно (Request 1)
                if (myTurn) {
                    guessInput.placeholder = "Введите фамилию игрока";
                    if(document.activeElement !== guessInput) { // Не переводить фокус, если уже печатаем
                       // guessInput.focus(); // Убрал авто-фокус, он может мешать
                    }
                } else {
                    guessInput.placeholder = "Ход соперника... (можно печатать)";
                }
                document.getElementById('submit-guess-btn').disabled = !myTurn;
                document.getElementById('surrender-btn').disabled = !myTurn;
                
                document.getElementById('guess-result-msg').textContent = '';
            }

            // --- НОВЫЙ ОБРАБОТЧИК GAME OVER (Request 2) ---
            function getEndReasonText(reason) {
                if (reason === 'unreachable_score') return 'Игра завершена досрочно: счет недосягаемый.';
                if (reason === 'normal') return 'Все раунды сыграны.';
                return 'Игра окончена.'; // Фолбэк
            }
            
            function getRoundOutcomeText(round, p1_nick, p2_nick) {
                const winnerIndex = round.winner_index;
                const reason = round.result_type;
                const loserNick = round.player_nickname;

                if (reason === 'completed' || winnerIndex === 'draw') {
                    return 'Ничья (все названы)';
                } else if (reason === 'surrender') {
                    const winnerNick = (loserNick === p1_nick) ? p2_nick : p1_nick;
                    return `Победил ${winnerNick} (соперник сдался)`;
                } else if (reason === 'timeout') {
                     const winnerNick = (loserNick === p1_nick) ? p2_nick : p1_nick;
                    return `Победил ${winnerNick} (время вышло)`;
                }
                return 'н/д';
            }

            socket.on('game_over', (data) => {
                if (gameTimerInterval) clearInterval(gameTimerInterval);
                 // Очищаем и таймер summary на всякий случай
                if (summaryCountdownInterval) {
                    clearInterval(summaryCountdownInterval);
                    summaryCountdownInterval = null;
                }
                
                const p1_nick = data.players[0].nickname;
                // Проверяем, есть ли второй игрок (для соло режима)
                const p2_nick = data.players[1] ? data.players[1].nickname : null;
                
                document.getElementById('game-over-score').textContent = `Счет ${data.final_scores[0]} - ${data.final_scores[1] || 0}`;
                document.getElementById('game-over-reason').textContent = getEndReasonText(data.end_reason);

                let ratingText = '';
                if (data.mode === 'solo') {
                    ratingText = 'Рейтинг в тренировке не меняется.';
                } else if (data.rating_changes) {
                    const p1 = data.rating_changes['0'];
                    const p2 = data.rating_changes['1'];
                    const p1_diff = p1.new - p1.old;
                    const p2_diff = p2.new - p2.old;
                    
                    ratingText = `
                        <b>${p1.nickname}:</b> ${p1.new} (${p1_diff >= 0 ? '+' : ''}${p1_diff})<br>
                        <b>${p2.nickname}:</b> ${p2.new} (${p2_diff >= 0 ? '+' : ''}${p2_diff})
                    `;
                } else {
                     ratingText = 'Не удалось загрузить изменение рейтинга.';
                }
                document.getElementById('game-over-ratings').innerHTML = ratingText;

                const historyTable = document.querySelector('#game-over-table tbody');
                historyTable.innerHTML = '';
                
                if (data.history && data.history.length > 0) {
                    data.history.forEach((round, index) => {
                        const tr = document.createElement('tr');
                        // В соло режиме нет ников для истории раунда
                        const outcomeText = getRoundOutcomeText(round, p1_nick, p2_nick || 'Тренировка'); 
                        
                        tr.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${round.club_name}</td>
                            <td>${outcomeText}</td>
                        `;
                        historyTable.appendChild(tr);
                    });
                } else {
                    historyTable.innerHTML = `<tr><td colspan="3">История раундов пуста.</td></tr>`;
                }

                showScreen('gameOver');
            });

            socket.on('turn_updated', (state) => {
                updateGameUI(state);
            });

            socket.on('guess_result', (data) => {
                const msgEl = document.getElementById('guess-result-msg');
                if (data.result === 'correct') {
                    msgEl.textContent = `✅ Верно!`;
                    msgEl.style.color = 'var(--correct-color)';
                } else if (data.result === 'correct_typo') {
                    msgEl.textContent = `✅ Верно (исправлено): ${data.corrected_name}`;
                    msgEl.style.color = 'var(--correct-color)';
                } else if (data.result === 'already_named') {
                    msgEl.textContent = 'Этот игрок уже был назван!';
                    msgEl.style.color = 'var(--incorrect-color)';
                } else if (data.result === 'not_found') {
                    msgEl.textContent = '❌ Неверно';
                    msgEl.style.color = 'var(--incorrect-color)';
                }
                setTimeout(() => { msgEl.textContent = ''; }, 2000);
            });
            
            // --- КНОПКИ ЛОББИ И НАСТРОЕК ---
            const nicknameInput = document.getElementById('nickname-input');
            const submitNicknameBtn = document.getElementById('submit-nickname-btn');
            submitNicknameBtn.addEventListener('click', () => {
                socket.emit('set_initial_username', { nickname: nicknameInput.value.trim(), telegram_id: localState.telegramId });
            });

            document.getElementById('create-game-btn').addEventListener('click', () => openSettings(false));
            document.getElementById('start-training-btn').addEventListener('click', () => openSettings(true));
            document.getElementById('back-to-lobby-btn').addEventListener('click', () => showScreen('lobby'));
            document.getElementById('surrender-btn').addEventListener('click', () => {
                socket.emit('surrender_round', { roomId: localState.currentRoomId });
            });

            function openSettings(isTraining) {
                settingsTitle.textContent = isTraining ? 'Настройки Тренировки' : 'Настройки PvP Игры';
                confirmTrainingBtn.style.display = isTraining ? 'block' : 'none';
                confirmCreateBtn.style.display = isTraining ? 'none' : 'block';
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                document.querySelector('.tab-btn[data-tab="random"]').classList.add('active');
                document.getElementById('tab-random').classList.add('active');

                socket.emit('get_league_clubs', { league: document.getElementById('league-select').value });
                showScreen('settings');
            }

            // --- ЛОГИКА ЭКРАНА НАСТРОЕК ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const tabId = button.getAttribute('data-tab');
                    tabContents.forEach(content => content.classList.toggle('active', content.id === `tab-${tabId}`));
                    validateSettings();
                });
            });

            socket.on('league_clubs_data', (data) => {
                localState.maxClubsInLeague = data.clubs.length;
                randomClubsSlider.max = localState.maxClubsInLeague;
                const defaultValue = Math.min(10, localState.maxClubsInLeague);
                randomClubsSlider.value = defaultValue;
                randomClubsLabel.textContent = `Количество клубов: ${defaultValue}`;
                maxClubsCountSpan.textContent = localState.maxClubsInLeague;
                clubsSelectionList.innerHTML = '';
                data.clubs.forEach(club => {
                    clubsSelectionList.innerHTML += `<label class="club-item"><input type="checkbox" id="club-${club}" value="${club}"><span style="margin-left: 8px;">${club}</span></label>`;
                });
                validateSettings();
            });

            randomClubsSlider.addEventListener('input', () => {
                randomClubsLabel.textContent = `Количество клубов: ${randomClubsSlider.value}`;
                validateSettings();
            });

            clubsSelectionList.addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') validateSettings();
            });

            function validateSettings() {
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                let isValid = false; let error = "";
                if (activeTab === 'random') {
                    const count = parseInt(randomClubsSlider.value, 10);
                    if (count < 3) error = "Нужно выбрать минимум 3 клуба.";
                    else isValid = true;
                } else if (activeTab === 'manual') {
                    const checkedCount = document.querySelectorAll('#clubs-selection-list input:checked').length;
                    manualClubsCount.textContent = `Выбрано: ${checkedCount}`;
                    if (checkedCount < 3) error = `Нужно выбрать минимум 3 клуба (выбрано ${checkedCount}).`;
                    else isValid = true;
                }
                settingsErrorMsg.textContent = error;
                confirmCreateBtn.disabled = !isValid;
                confirmTrainingBtn.disabled = !isValid;
            }

            function handleCreateGame(isTraining) {
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                let settings = {
                    league: document.getElementById('league-select').value,
                    time_bank: parseFloat(document.getElementById('time-bank-input').value),
                    num_rounds: 0, selected_clubs: []
                };
                if (activeTab === 'random') settings.num_rounds = parseInt(randomClubsSlider.value, 10);
                else if (activeTab === 'manual') settings.selected_clubs = Array.from(document.querySelectorAll('#clubs-selection-list input:checked')).map(cb => cb.value);
                
                if (isTraining) socket.emit('start_game', { mode: 'solo', nickname: localState.nickname, settings: settings });
                else { socket.emit('create_game', { nickname: localState.nickname, settings: settings }); showScreen('lobby'); }
            }

            confirmCreateBtn.addEventListener('click', () => handleCreateGame(false));
            confirmTrainingBtn.addEventListener('click', () => handleCreateGame(true));
            
            // --- ЛОГИКА ЛОББИ ---
            openGamesList.addEventListener('click', (e) => {
                if (e.target.classList.contains('join-btn')) socket.emit('join_game', { creator_sid: e.target.getAttribute('data-creator-sid'), nickname: localState.nickname });
                if (e.target.classList.contains('cancel-btn')) socket.emit('cancel_game');
            });

            socket.on('update_lobby', (games) => {
                openGamesList.innerHTML = games.length === 0 ? '<p>Нет доступных игр.</p>' : '';
                games.forEach(game => {
                    let clubsText = ''; const settings = game.settings;
                    if (settings.selected_clubs && settings.selected_clubs.length > 0) clubsText = `Клубы: ${settings.selected_clubs.join(', ')}`;
                    else if (settings.num_rounds && settings.num_rounds > 0) clubsText = `Случайные клубы: ${settings.num_rounds} шт.`;
                    else clubsText = 'Все клубы лиги'; 
                    let buttonHtml = (game.creator_sid === socket.id) 
                        ? `<button class="cancel-btn" data-creator-sid="${game.creator_sid}">Отменить</button>`
                        : `<button class="join-btn" data-creator-sid="${game.creator_sid}">Войти</button>`;
                    openGamesList.innerHTML += `<div class="game-card"><div class="game-card-info"><p><strong>${game.creator_nickname}</strong> (${game.creator_rating})</p><p style="font-size:12px;">${clubsText}</p></div>${buttonHtml}</div>`;
                });
            });
            
            socket.on('lobby_stats_update', (stats) => {
                document.getElementById('lobby-stats').textContent = `В лобби: ${stats.players_in_lobby} | В игре: ${stats.players_in_game}`;
            });

            const submitGuessBtn = document.getElementById('submit-guess-btn');
            const guessInput = document.getElementById('guess-input');
            submitGuessBtn.addEventListener('click', () => {
                if(guessInput.value.trim() !== '') {
                    socket.emit('submit_guess', { roomId: localState.currentRoomId, guess: guessInput.value });
                    guessInput.value = '';
                }
            });
            guessInput.addEventListener('keyup', (e) => e.key === 'Enter' && submitGuessBtn.click());
            
            document.getElementById('show-leaderboard-btn').addEventListener('click', () => {
                socket.emit('get_leaderboard');
                showScreen('leaderboard');
            });
            document.getElementById('leaderboard-back-btn').addEventListener('click', () => showScreen('lobby'));

            socket.on('leaderboard_data', (data) => {
                const tableBody = document.querySelector('#leaderboard-table tbody');
                tableBody.innerHTML = '';
                data.forEach((user, index) => {
                    tableBody.innerHTML += `<tr><td>${index + 1}</td><td>${user.nickname}</td><td>${user.rating}</td><td>${user.games_played}</td></tr>`;
                });
            });
            
            socket.on('opponent_disconnected', (data) => {
                alert(data.message || 'Соперник отключился.');
                // Очищаем таймеры на всякий случай
                if (gameTimerInterval) clearInterval(gameTimerInterval);
                if (summaryCountdownInterval) clearInterval(summaryCountdownInterval);
                showScreen('lobby');
            });
        });
    </script>
</body>
</html>