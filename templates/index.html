<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Футбольная игра</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a; --primary-color: #2c2c2c; --secondary-color: #444;
            --text-color: #f0f0f0; --accent-color: #0088cc; --accent-hover-color: #00aaff;
            --correct-color: #28a745; --incorrect-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }
        .screen { display: none; width: 100%; height: 100%; overflow-y: auto; box-sizing: border-box; padding: 15px; }
        .screen.active { display: flex; flex-direction: column; align-items: center; }
        button { background-color: var(--accent-color); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background-color 0.2s; }
        button:hover { background-color: var(--accent-hover-color); }
        button:disabled { background-color: var(--secondary-color); cursor: not-allowed; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid var(--secondary-color); background-color: var(--primary-color); color: var(--text-color); font-size: 16px; box-sizing: border-box; }
        .container { width: 100%; max-width: 600px; margin: 0 auto; text-align: center; }
        #loading-screen { justify-content: center; }
        .loader { border: 8px solid var(--secondary-color); border-top: 8px solid var(--accent-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #nickname-screen .container { display: flex; flex-direction: column; justify-content: center; height: 100%; }
        #lobby-screen h1 { margin-top: 0; }
        .game-card { background-color: var(--primary-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; text-align: left; display: flex; justify-content: space-between; align-items: center; }
        .game-card-info p { margin: 4px 0; }
        #settings-screen .container { text-align: left; }
        #game-screen .game-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 15px; }
        .player-info.active { border-bottom: 2px solid var(--accent-color); }
        #named-players-list, #summary-player-list { list-style: none; padding: 0; max-height: 40vh; overflow-y: auto; margin: 15px 0; text-align: left; }
        #leaderboard-screen table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #leaderboard-screen th, #leaderboard-screen td { padding: 10px; border-bottom: 1px solid var(--secondary-color); text-align: left; }
        /* Стили для нового экрана */
        #summary-screen .container { text-align: center; }
    </style>
</head>
<body>

    <div id="loading-screen" class="screen active"><div class="container"><div class="loader"></div><p>Подключение...</p></div></div>
    <div id="nickname-screen" class="screen"><div class="container"><h2>Добро пожаловать!</h2><p>Придумайте себе уникальный никнейм.</p><input type="text" id="nickname-input" placeholder="Введите ваш никнейм"><button id="submit-nickname-btn">Сохранить</button><p id="nickname-error" style="color: var(--incorrect-color);"></p></div></div>
    <div id="lobby-screen" class="screen"><div class="container"><h1>Лобби</h1><p id="welcome-message"></p><div id="lobby-stats"></div><div class="lobby-actions" style="display: flex; justify-content: space-around; margin-bottom: 20px;"><button id="create-game-btn">Создать игру</button><button id="start-training-btn">Тренировка</button><button id="show-leaderboard-btn">Рейтинг</button></div><h2>Открытые игры:</h2><div id="open-games-list"></div></div></div>
    <div id="settings-screen" class="screen"><div class="container"><h2>Настройки Игры</h2><div class="setting"><label for="league-select">Лига:</label><select id="league-select"><option value="РПЛ">РПЛ</option></select></div><div class="setting"><label for="time-bank-input">Тайм-банк (сек):</label><input type="number" id="time-bank-input" value="90" min="30" max="300"></div><div class="setting"><label>Выбор клубов:</label><div id="clubs-selection"></div></div><button id="confirm-create-game-btn">Создать PvP Игру</button><button id="confirm-training-btn" style="display: none;">Начать Тренировку</button><button id="back-to-lobby-btn">Назад</button></div></div>
    
    <div id="game-screen" class="screen">
        <div class="container">
            <div class="game-header">
                <div class="player-info" id="player-0-info"><div class="nickname">...</div><div class="time-bank">...</div><div class="score">...</div></div>
                <div id="round-info">...</div>
                <div class="player-info" id="player-1-info"><div class="nickname">...</div><div class="time-bank">...</div><div class="score">...</div></div>
            </div>
            <h2 id="club-name-display">Клуб...</h2>
            <ul id="named-players-list"></ul>
            <p id="guess-result-msg" style="height: 20px;"></p>
            <input type="text" id="guess-input" placeholder="Введите фамилию игрока">
            <button id="submit-guess-btn">Ответить</button>
            <button id="surrender-btn" style="background-color: #aa4a44;">Сдаться</button>
        </div>
    </div>

    <div id="summary-screen" class="screen">
        <div class="container">
            <h2 id="summary-title">Раунд завершен!</h2>
            <h3 id="summary-club-name"></h3>
            <p><strong>Текущий счет: <span id="summary-score"></span></strong></p>
            <ul id="summary-player-list">
                </ul>
            <button id="skip-pause-btn">Следующий раунд</button>
        </div>
    </div>
    
    <div id="leaderboard-screen" class="screen">
        <div class="container">
            <h2>Таблица Лидеров</h2>
            <table id="leaderboard-table">
                <thead><tr><th>#</th><th>Никнейм</th><th>Рейтинг</th><th>Игр сыграно</th></tr></thead>
                <tbody></tbody>
            </table>
            <button id="leaderboard-back-btn">Назад</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            let localState = { nickname: null, telegramId: null, currentRoomId: null, myPlayerIndex: null };
            const screens = {
                loading: document.getElementById('loading-screen'),
                nickname: document.getElementById('nickname-screen'),
                lobby: document.getElementById('lobby-screen'),
                settings: document.getElementById('settings-screen'),
                game: document.getElementById('game-screen'),
                summary: document.getElementById('summary-screen'), // Новый экран
                leaderboard: document.getElementById('leaderboard-screen'),
            };

            const skipPauseBtn = document.getElementById('skip-pause-btn');

            function showScreen(screenName) {
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenName].classList.add('active');
            }

            // --- ОБРАБОТЧИКИ СОБЫТИЙ ---

            // Аутентификация и лобби (без изменений)
            socket.on('auth_request', () => tg.initData && socket.emit('login_with_telegram', { initData: tg.initData }));
            socket.on('request_nickname', (data) => { localState.telegramId = data.telegram_id; showScreen('nickname'); });
            socket.on('auth_status', (data) => {
                if (data.success) {
                    localState.nickname = data.nickname;
                    document.getElementById('welcome-message').textContent = `Добро пожаловать, ${localState.nickname}!`;
                    showScreen('lobby');
                }
            });
            // ... остальная логика лобби, настроек и т.д. ...

            // --- НОВАЯ ЛОГИКА ДЛЯ ЭКРАНА ИТОГОВ РАУНДА ---

            socket.on('round_summary', (data) => {
                // Заполняем данными экран итогов
                document.getElementById('summary-club-name').textContent = data.clubName;
                const p1_score = data.scores[0] || 0;
                const p2_score = data.scores[1] || 0;
                document.getElementById('summary-score').textContent = `${p1_score} - ${p2_score}`;

                const summaryList = document.getElementById('summary-player-list');
                summaryList.innerHTML = '<h4>Весь состав:</h4>';
                const namedFullNames = data.namedPlayers.map(p => p.full_name);
                
                data.fullPlayerList.forEach(fullName => {
                    const li = document.createElement('li');
                    const namedPlayer = data.namedPlayers.find(p => p.full_name === fullName);
                    if (namedPlayer) {
                        const authorNickname = data.players[namedPlayer.by].nickname;
                        li.innerHTML = `✅ ${fullName} (<em>${authorNickname}</em>)`;
                    } else {
                        li.innerHTML = `❌ ${fullName}`;
                    }
                    summaryList.appendChild(li);
                });

                // Сбрасываем текст кнопки и показываем экран
                skipPauseBtn.textContent = 'Следующий раунд';
                skipPauseBtn.disabled = false;
                showScreen('summary');
            });

            // Игрок нажимает кнопку "Следующий раунд"
            skipPauseBtn.addEventListener('click', () => {
                socket.emit('request_skip_pause', { roomId: localState.currentRoomId });
                // Блокируем кнопку после нажатия, чтобы избежать повторных отправок
                skipPauseBtn.disabled = true;
                skipPauseBtn.textContent = 'Ожидаем второго игрока...';
            });

            // Сервер сообщает об обновлении голосов
            socket.on('skip_vote_update', (data) => {
                // Обновляем текст кнопки для всех игроков
                const btn = document.getElementById('skip-pause-btn');
                btn.textContent = `Следующий раунд (${data.count}/2)`;
            });

            // --- СТАРЫЕ ОБРАБОТЧИКИ ---
            socket.on('round_started', (state) => {
                showScreen('game');
                updateGameUI(state);
            });
            
            function updateGameUI(state) {
                localState.currentRoomId = state.roomId;
                for (const index in state.players) {
                    if (state.players[index].nickname === localState.nickname) {
                        localState.myPlayerIndex = parseInt(index); break;
                    }
                }
                document.getElementById('round-info').textContent = `Раунд ${state.round}/${state.totalRounds}`;
                document.getElementById('club-name-display').textContent = state.clubName;
                for (let i = 0; i < 2; i++) {
                    const playerInfoEl = document.getElementById(`player-${i}-info`);
                    if (state.players[i]) {
                        playerInfoEl.style.display = 'block';
                        playerInfoEl.querySelector('.nickname').textContent = state.players[i].nickname;
                        playerInfoEl.querySelector('.score').textContent = state.scores[i] || 0;
                        playerInfoEl.querySelector('.time-bank').textContent = `${(state.timeBanks[i] || 0).toFixed(1)}с`;
                        playerInfoEl.classList.toggle('active', i === state.currentPlayerIndex);
                    } else {
                        playerInfoEl.style.display = 'none';
                    }
                }
                const namedPlayersList = document.getElementById('named-players-list');
                namedPlayersList.innerHTML = '';
                state.namedPlayers.forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = `${p.full_name} (${state.players[p.by].nickname})`;
                    namedPlayersList.appendChild(li);
                });
                const myTurn = state.currentPlayerIndex === localState.myPlayerIndex;
                const guessInput = document.getElementById('guess-input');
                guessInput.disabled = !myTurn;
                document.getElementById('submit-guess-btn').disabled = !myTurn;
                document.getElementById('surrender-btn').disabled = !myTurn;
                if(myTurn) guessInput.focus();
            }

            socket.on('game_over', (data) => {
                let message = `Игра окончена!\nСчет: ${data.final_scores[0]} - ${data.final_scores[1] || 0}\n\n`;
                if(data.rating_changes && data.players[localState.myPlayerIndex]) {
                    const myChangesKey = localState.myPlayerIndex === 0 ? 'p1' : 'p2';
                    const myChanges = data.rating_changes[myChangesKey];
                    const ratingDiff = myChanges.new - myChanges.old;
                    message += `Ваш рейтинг: ${myChanges.new} (${ratingDiff >= 0 ? '+' : ''}${ratingDiff})`;
                }
                alert(message);
                showScreen('lobby');
            });
            
            // --- Остальная часть JS-кода (настройки, таблица лидеров и т.д.) остается без изменений ---
            // Код для кнопок, инпутов и т.д.
            const nicknameInput = document.getElementById('nickname-input');
            const submitNicknameBtn = document.getElementById('submit-nickname-btn');
            submitNicknameBtn.addEventListener('click', () => {
                socket.emit('set_initial_username', { nickname: nicknameInput.value.trim(), telegram_id: localState.telegramId });
            });

            document.getElementById('create-game-btn').addEventListener('click', () => openSettings(false));
            document.getElementById('start-training-btn').addEventListener('click', () => openSettings(true));
            document.getElementById('back-to-lobby-btn').addEventListener('click', () => showScreen('lobby'));

            function openSettings(isTraining) {
                document.getElementById('confirm-training-btn').style.display = isTraining ? 'block' : 'none';
                document.getElementById('confirm-create-game-btn').style.display = isTraining ? 'none' : 'block';
                socket.emit('get_league_clubs', { league: document.getElementById('league-select').value });
                showScreen('settings');
            }

            socket.on('league_clubs_data', (data) => {
                const clubsSelection = document.getElementById('clubs-selection');
                clubsSelection.innerHTML = '';
                data.clubs.forEach(club => {
                    clubsSelection.innerHTML += `<div class="club-item"><input type="checkbox" id="club-${club}" value="${club}"><label for="club-${club}" style="margin-left: 8px;">${club}</label></div>`;
                });
            });

            function handleCreateGame(isTraining) {
                const settings = {
                    league: document.getElementById('league-select').value,
                    time_bank: parseFloat(document.getElementById('time-bank-input').value),
                    selected_clubs: Array.from(document.querySelectorAll('#clubs-selection input:checked')).map(cb => cb.value)
                };
                if (isTraining) {
                    socket.emit('start_game', { mode: 'solo', nickname: localState.nickname, settings: settings });
                } else {
                    socket.emit('create_game', { nickname: localState.nickname, settings: settings });
                    showScreen('lobby');
                }
            }
            document.getElementById('confirm-create-game-btn').addEventListener('click', () => handleCreateGame(false));
            document.getElementById('confirm-training-btn').addEventListener('click', () => handleCreateGame(true));
            
            const openGamesList = document.getElementById('open-games-list');
            openGamesList.addEventListener('click', (e) => {
                if (e.target.classList.contains('join-btn')) {
                    socket.emit('join_game', { creator_sid: e.target.getAttribute('data-creator-sid'), nickname: localState.nickname });
                }
            });

            socket.on('update_lobby', (games) => {
                openGamesList.innerHTML = games.length === 0 ? '<p>Нет доступных игр.</p>' : '';
                games.forEach(game => {
                    let clubsText = 'Все клубы лиги';
                    if (game.selected_clubs_names && game.selected_clubs_names.length > 0) {
                        clubsText = `Клубы: ${game.selected_clubs_names.join(', ')}`;
                    }
                    openGamesList.innerHTML += `<div class="game-card"><div class="game-card-info"><p><strong>${game.creator_nickname}</strong> (${game.creator_rating})</p><p style="font-size:12px;">${clubsText}</p></div><button class="join-btn" data-creator-sid="${game.creator_sid}">Войти</button></div>`;
                });
            });

            const submitGuessBtn = document.getElementById('submit-guess-btn');
            const guessInput = document.getElementById('guess-input');
            submitGuessBtn.addEventListener('click', () => {
                if(guessInput.value.trim() !== '') {
                    socket.emit('submit_guess', { roomId: localState.currentRoomId, guess: guessInput.value });
                    guessInput.value = '';
                }
            });
            guessInput.addEventListener('keyup', (e) => e.key === 'Enter' && submitGuessBtn.click());
            
            document.getElementById('show-leaderboard-btn').addEventListener('click', () => {
                socket.emit('get_leaderboard');
                showScreen('leaderboard');
            });
            document.getElementById('leaderboard-back-btn').addEventListener('click', () => showScreen('lobby'));

            socket.on('leaderboard_data', (data) => {
                const tableBody = document.querySelector('#leaderboard-table tbody');
                tableBody.innerHTML = '';
                data.forEach((user, index) => {
                    tableBody.innerHTML += `<tr><td>${index + 1}</td><td>${user.nickname}</td><td>${user.rating}</td><td>${user.games_played}</td></tr>`;
                });
            });
        });
    </script>
</body>
</html>