# bot.py
import asyncio
import os
import logging
import sys

from aiogram import Bot, Dispatcher, F
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart
from aiogram.types import Message
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import WebAppInfo
# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 1: –î–û–ë–ê–í–õ–Ø–ï–ú –ù–û–í–´–ô –ò–ú–ü–û–†–¢ ---
from aiogram.client.default import DefaultBotProperties

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ---
# –ë–µ—Ä–µ–º —Ç–æ—Ç –∂–µ —Ç–æ–∫–µ–Ω, —á—Ç–æ –∏ –¥–ª—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')
if not TOKEN:
    raise ValueError("–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN")

# –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–≤–æ–π Web App (–¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–æ–π, —á—Ç–æ —Ç—ã –¥–∞–≤–∞–ª BotFather)
# –§–æ—Ä–º–∞—Ç: https://t.me/–ò–ú–Ø_–¢–í–û–ï–ì–û_–ë–û–¢–ê/–ò–ú–Ø_WEB_APP
WEB_APP_URL = "https://t.me/rplquizbot/rplquizbot"

# –¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
WELCOME_TEXT = """–ü—Ä–∏–≤–µ—Ç, —Ñ–∞–Ω–∞—Ç —Ñ—É—Ç–±–æ–ª–∞! ‚öΩÔ∏è

–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ **RPL QuizBot** ‚Äî –≥–ª–∞–≤–Ω—É—é –≤–∏–∫—Ç–æ—Ä–∏–Ω—É –ø–æ –†–æ—Å—Å–∏–π—Å–∫–æ–π –ü—Ä–µ–º—å–µ—Ä-–õ–∏–≥–µ!

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –≤—Å–ø–æ–º–Ω–∏—Ç—å –∏ –Ω–∞–∑–≤–∞—Ç—å –∫–∞–∫ –º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–∞–≤–∞ –∫–ª—É–±–∞ –†–ü–õ. –î—É–º–∞–µ—à—å, —É —Ç–µ–±—è –ø–æ–ª—É—á–∏—Ç—Å—è?

---

**–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:**

1.  **–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º:**
    * **üèÜ PvP (1 –Ω–∞ 1):** –°–æ—Ä–µ–≤–Ω—É–π—Å—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏! –¢—ã –¥–µ–ª–∞–µ—à—å —Ö–æ–¥, –ø–æ—Ç–æ–º ‚Äî —Å–æ–ø–µ—Ä–Ω–∏–∫.
    * **üèãÔ∏è –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞:** –ò–≥—Ä–∞–π –≤ —Å–æ–ª–æ-—Ä–µ–∂–∏–º–µ, —á—Ç–æ–±—ã –æ—Ç—Ç–æ—á–∏—Ç—å —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è.

2.  **–ù–∞–∑—ã–≤–∞–π –∏–≥—Ä–æ–∫–æ–≤:**
    * –£–≥–∞–¥–∞–ª —Ñ–∞–º–∏–ª–∏—é ‚Äî —Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–æ–ø–µ—Ä–Ω–∏–∫—É (–≤ PvP).
    * –¢–∞–π–º-–±–∞–Ω–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 90 —Å–µ–∫.) —Ç—Ä–∞—Ç–∏—Ç—Å—è, –ø–æ–∫–∞ —Ç—ã –¥—É–º–∞–µ—à—å.

3.  **–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π –æ—á–∫–∏ (–≤ PvP):**
    * –ï—Å–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫ –Ω–µ —É–≥–∞–¥–∞–ª (–≤—Ä–µ–º—è –≤—ã—à–ª–æ –∏–ª–∏ –æ–Ω —Å–¥–∞–ª—Å—è) ‚Äî —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å **+1 –æ—á–∫–æ**.
    * –ï—Å–ª–∏ –≤—ã –≤–º–µ—Å—Ç–µ –Ω–∞–∑–≤–∞–ª–∏ *–≤–µ—Å—å* —Å–æ—Å—Ç–∞–≤ ‚Äî —Ä–∞—É–Ω–¥ "–≤–Ω–∏—á—å—é", –∏ –≤—ã –æ–±–∞ –ø–æ–ª—É—á–∞–µ—Ç–µ –ø–æ **+0.5 –æ—á–∫–∞**.

4.  **–°—Ç–∞–Ω—å –ª—É—á—à–∏–º:**
    * –ü–æ–±–µ–∂–¥–∞–π –≤ –º–∞—Ç—á–∞—Ö, –ø–æ–≤—ã—à–∞–π —Å–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥ Glicko-2 –∏ –ø–æ–¥–Ω–∏–º–∞–π—Å—è –≤ –¢–∞–±–ª–∏—Ü–µ –õ–∏–¥–µ—Ä–æ–≤!

---

–ì–æ—Ç–æ–≤ –Ω–∞—á–∞—Ç—å? üëá
"""

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä
dp = Dispatcher()

# --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï 2: –ò–ó–ú–ï–ù–Ø–ï–ú –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Æ –ë–û–¢–ê ---
# –°—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± (parse_mode=...) —É–¥–∞–ª–µ–Ω –≤ aiogram 3.7.0+
# bot = Bot(TOKEN, parse_mode=ParseMode.MARKDOWN) # <-- –¢–≤–æ—è –æ—à–∏–±–∫–∞ –±—ã–ª–∞ —Ç—É—Ç
#
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —Å–ø–æ—Å–æ–± —á–µ—Ä–µ–∑ DefaultBotProperties:
bot = Bot(
    TOKEN, 
    default=DefaultBotProperties(parse_mode=ParseMode.MARKDOWN)
)
# --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start ---

@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    """
    –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ª–æ–≤–∏—Ç –∫–æ–º–∞–Ω–¥—É /start
    –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–æ–π Web App.
    """
    # –°–æ–∑–¥–∞–µ–º –±–∏–ª–¥–µ—Ä –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    builder = InlineKeyboardBuilder()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç Web App
    builder.button(
        text="üöÄ –ù–∞—á–∞—Ç—å –∏–≥—Ä—É!", 
        web_app=WebAppInfo(url=WEB_APP_URL)
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await message.answer(
        WELCOME_TEXT,
        reply_markup=builder.as_markup()
    )

@dp.message()
async def any_text_handler(message: Message):
    """
    –õ–æ–≤–∏—Ç –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç –∏ –≤–µ–∂–ª–∏–≤–æ –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç, 
    –∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É.
    """
    # –°–æ–∑–¥–∞–µ–º –±–∏–ª–¥–µ—Ä –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    builder = InlineKeyboardBuilder()
    builder.button(
        text="üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–≥—Ä—É", 
        web_app=WebAppInfo(url=WEB_APP_URL)
    )
    
    await message.answer(
        text="–Ø –Ω–µ –æ–±—â–∞—é—Å—å –≤ —á–∞—Ç–µ, –º–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∑–∞–ø—É—Å–∫–∞—Ç—å –∏–≥—Ä—É-–≤–∏–∫—Ç–æ—Ä–∏–Ω—É.\n\n–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å üëá",
        reply_markup=builder.as_markup()
    )

# --- –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞ ---

async def main() -> None:
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ (polling - –æ–Ω –±—É–¥–µ—Ç —Å–∞–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å Telegram –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö)
    print("–ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç–∞...")
    await dp.start_polling(bot)

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO, stream=sys.stdout)
    asyncio.run(main())